import{$ as e,aG as t,aH as i,aI as a,_ as r,aJ as n,aK as o,aL as s,J as l,aM as d,aN as c,aO as h,W as u,aP as m,aQ as p,aR as f,aS as v,aT as g,aU as w,aV as y,t as b,p as T,c as S,aW as E,aX as C,d as x,aY as P,f as j,a as A,ai as k,D as O,A as R,aZ as _,w as L,a_ as B,n as I,e as F,a$ as D,aa as W,b0 as N,q as H,b1 as V,b2 as U,b3 as z,b4 as X,b5 as q,r as G,V as K,H as Y,E as Z,z as J,b6 as $,b7 as Q,b8 as ee,b9 as te,ba as ie,bb as ae,h as re,bc as ne,bd as oe,o as se,be as le,bf as de,bg as ce,bh as he,U as ue,bi as me,aE as pe,bj as fe,bk as ve,bl as ge}from"./vendor.js";class we{constructor(r){var{scene:n,sceneInstance:o,renderer:s,endSession:l}=r;this.endSession=l,this.engine=r,this.gui=e("#".concat(t)),this.hitSearch=e("#hud-searching-hittest"),this.spawnButton=e("#hud-spawn-artifact"),this.scene=n,this.renderer=s,this.sceneInstance=o,e.on("#".concat(i),"click",this.onExitButtonClick.bind(this)),a(this),this.animToggler=e("#toggle-animation-button")}setCamera(t){this.cameraAccess=t,t?e.show(this.recordVideoButton):e.hide(this.recordVideoButton)}showAnimToggler(t){this.animToggler&&(this.animToggler.classList.remove("play"),e.show(this.animToggler),this.animTogglerInit||(this.animTogglerInit=!0,this.eventListener=()=>{this.animToggler.classList.toggle("play"),t()},e.on(this.animToggler,"click",this.eventListener)))}hideAnimToggler(){e.hide(this.animToggler)}show(){e.show(this.gui)}hide(){e.hide(this.gui)}onExitButtonClick(){var t=this;return r((function*(){t.engine.endSession(),e.off(t.animToggler,"click",t.eventListener),n()}))()}showHitSearch(){e.show(this.hitSearch)}hideHitSearch(){e.hide(this.hitSearch)}showSpawnButton(){e.show(this.spawnButton)}hideSpawnButton(){e.hide(this.spawnButton)}showElement(t){t.shown||(e.show(t),t.shown=!0)}hideElement(t){t.shown&&(e.hide(t),t.shown=!1)}}var{SCENE_TYPES:ye}=u.APP_DB;class be{constructor(e){var{artifact:t,preload:i,XR:a}=e;this.XR=a,this.artifact=t,this.preload=i;var{type:r=ye.Hit}=t;this.type=r,this.clock=new o,this.scene=new s,this.customMaterials=[],this.spatials=[],this.spatialObjects=[],this.lookAtCameraObjects=[],this.animateObjects=[],this.audioAnalysers=[],this.audioAnalyserEmissionConfigs=[],this.objects={},this.circlingLights=[],this.customObjects=[],this.videoTargets=[],this.animationListeners=[],this.materialFadeAnimations=[],this.eventsToRemove=[],this.renderSteps=[],this.unspawnObjects=[],this.animations=[],this.randomAudioElements=[],this.onResize=this.onResize.bind(this),this.render=this.render.bind(this),this.initFallbackSession=this.initFallbackSession.bind(this),this.toggleAnimations=this.toggleAnimations.bind(this),this.endSession=this.endSession.bind(this),this.onAddArtifact=this.onAddArtifact.bind(this)}init(t){var i=this;return r((function*(){var a,{artifact:n,preload:o,scene:s,type:w,XR:y}=i;t&&(i.sceneInstance=t);var{fov:b,near:T,far:S}=l(n.cam,d),E=u.innerWidth/u.innerHeight;i.camera=new c(b,E,T,S),i.camera.updateProjectionMatrix(),s.add(i.camera);var C=new h({antialias:!0,alpha:!0});i.renderer=C,C.setPixelRatio(u.devicePixelRatio),C.setSize(u.innerWidth,u.innerHeight),C.domElement.id=m,C.useLegacyLights=!1,C.toneMapping=p;var{audio:x,audioElements:P,circlingLights:j,clickables:A,customMaterials:k,customObjects:M,fog:O,fogexp2:R,hideLight:_,ocean:L,particles:B,shadow:I,triggerVideo:F,underwater:D,wireframes:W,record3d:N,record3DImages:H,renderTargets:V,noShadowObjects:U,receiveNoShadowObjects:z,castNoShadowObjects:X,ws:q}=n;!1!==I&&(C.shadowMap.enabled=!0,C.shadowMap.type=f),i.hud=new we(i);var G=null===(a=i.artifact.animateObjects)||void 0===a?void 0:a.some((e=>e.sound));if((x||null!=P&&P.length||G)&&i.addAudio(),i.addSkybox(),_||i.addLights(),(O||R)&&i.addFog(),q&&i.sceneInstance){var{host:K,port:Y,protocol:Z}=q,J={host:K,port:Y,protocol:Z,scene:t};i.ws=new o.assets.WS(J)}if(i.videoElement=o.assets.videoElement,null!=t&&t.init&&(console.warn("`CustomScene.init` is deprecated","and will be removed in a future version. use `CustomScene.beforeLoadModel` instead."),yield t.init({engine:i,preload:o})),N&&n.type!==ye.FakeMirror&&!N.doNotInit){var $=i.videoElement,Q={artifact:n,engine:i,preload:o,videoElement:$},ee=new o.assets.Record3D(Q);i.record3d=ee,ee.model&&(i.model=ee.model),ee.child&&(i.child=ee.child),i.parentName=ee.config.parentName,i.renderSteps.push(ee.tick)}if(H){var{Class:te,images:ie}=o.assets.Record3DImages,ae=new te({engine:i,images:ie,config:H});i.record3DImages=ae}if(null!=t&&t.beforeLoadModel&&t.beforeLoadModel({engine:i,preload:o}),yield i.loadModel(),null!=t&&t.afterLoadModel&&t.afterLoadModel({engine:i,preload:o}),i.artifact.showVideoTime&&(i.frameRateIndicator=e.create("div",{style:{position:"fixed",top:0,left:0,backgroundColor:"black",color:"white"},parent:"#hud"})),U&&U.forEach((e=>{var t=i.model.getObjectByName(e);t&&(t.receiveShadow=!1,t.castShadow=!1)})),z&&z.forEach((e=>{var t=i.model.getObjectByName(e);t&&(t.receiveShadow=!1)})),X&&X.forEach((e=>{var t=i.model.getObjectByName(e);t&&(t.castShadow=!1)})),V&&i.addRenderTargets(),null!=j&&j.length){var{CirclingLights:re}=yield import("./vendor.js").then((function(e){return e.bo}));new re(i)}if(k&&new o.assets.CustomMaterials(i),M&&(yield i.addCustomObjects()),W&&W.forEach((e=>{var t=i.model.getObjectByName(e.target);t&&t.material&&(t.material.wireframe=!0,e.transparent&&(t.material.transparent=!0,t.material.opacity=e.opacity))})),F&&(i.objects.videoTrigger=new o.assets.VideoTrigger(i)),D&&(yield i.addUnderwaterPlane()),L&&(i.objects.oceanPlane=new o.assets.OceanPlane({artifact:n,engine:i,preload:i.preload})),B&&(i.particles=new o.assets.Particles(i),yield i.particles.init()),C.setSize(u.innerWidth,u.innerHeight),e.append(C.domElement,"#".concat(v)),y)try{var ne=C.xr.getController(0);i.controller=ne;var{clickable:oe,shadow:se,shadowPlane:le}=n;if(!1!==se&&!1!==le&&i.addShadowPlane(),!i.isHittestScene())throw new Error("Unknown scene type ".concat(w));w!==ye.Float&&i.spawnReticle(),e.on(i.hud.spawnButton,"click",i.onAddArtifact),e.on(ne,"select",i.onAddArtifact),oe||i.hud.hideAnimToggler(),s.add(ne),i.initScene=r((function*(){var t=["hit-test","dom-overlay"];g&&t.push("anchors"),e.hide("#Locator");var a=yield u.NAV.xr.requestSession("immersive-ar",{requiredFeatures:t,domOverlay:{root:e("#hud")}});return i.refSpace=yield a.requestReferenceSpace("viewer"),i.localRefSpace=yield a.requestReferenceSpace("local"),i.renderer.xr.enabled=!0,i.renderer.xr.setReferenceSpaceType("local"),yield i.renderer.xr.setSession(a),a.initFallbackSession=i.initFallbackSession.bind(i),i.session=a,a}))}catch(e){i.initScene=i.initFallbackSession}else i.initScene=i.initFallbackSession;return null!=A&&A.length&&i.addClickables(),e.on(u,"resize",i.onResize),i.onResize(),C.setAnimationLoop(i.render),i}))()}onAddArtifact(){var e=this;return r((function*(){var{artifact:t,justUnspawned:i,modelSpawned:a}=e;if(!i){if(!a){yield e.spawnModel(!1)}t.clickable?e.hud.showAnimToggler(e.toggleAnimations):e.hud.hideAnimToggler()}}))()}onResize(){var{innerWidth:e,innerHeight:t}=u;this.camera.aspect=e/t,this.camera.updateProjectionMatrix(),this.renderer.setSize(e,t)}addRenderTargets(){var{renderTargets:e}=this.artifact;this.renderTargets=[],e.forEach((e=>{var t=l(e,{height:512,width:512,options:{depthBuffer:!1,stencilBuffer:!1},off:[]}),i=[];t.off.length&&t.off.forEach((e=>{var t=this.model.getObjectByName(e);t&&i.push(t)})),this.renderTargets.push({height:t.height,width:t.width,off:i,object:new w(t.width,t.height,t.options)})}))}addLights(){var{directionalLightPosition:e=te.directionalPosition,directionalColor:t=te.directionalColor,directionalIntensity:i=te.directionalIntensity,ambientColor:a=te.ambientColor,ambientIntensity:r=te.ambientIntensity}=this.artifact,n=new y(t,i);n.position.set(...e),n.castShadow=!0,!1!==this.artifact.shadow&&(n.shadow.bias=-1e-4,n.shadow.mapSize.width=4096,n.shadow.mapSize.height=4096,n.shadow.camera.left=-70,n.shadow.camera.right=70,n.shadow.camera.top=70,n.shadow.camera.bottom=-70,n.shadow.camera.near=.1,n.shadow.camera.far=300),this.directionalLight=n,this.scene.add(n),this.ambientLight=new b(a,r),this.scene.add(this.ambientLight)}addCustomObjects(){var{artifact:e}=this,{customObjects:t}=e;t.forEach((e=>{var{config:t,object:i}=e,a=this.model.getObjectByName(t.target);a&&(i.child?a.add(i.child):i.model&&(a.parent.add(i.model),a.parent.remove(a)),this.customObjects.push({config:t,object:i}),T.fn(i.init)&&i.init({engine:this}))}))}addShadowPlane(){var e=new S(150,150,64,64),t=new E;t.opacity=C;var i=new x(e,t);i.receiveShadow=!0,i.lookAt(0,100,0),i.position.set(0,.01,0),this.shadowPlane=i}addPortal(){this.objects.portal=new this.preload.assets.Portal.Factory({engine:this,mergeConfig:l})}spawnReticle(){var e=new P(.15,.2,32).rotateX(-M.PI/2),t=new j;this.reticle=new x(e,t),this.reticle.matrixAutoUpdate=!1,this.reticle.visible=!1,this.scene.add(this.reticle)}onAnimationLoop(e,t){var i=e.action._clip.name;t.forEach((e=>{if(!this.materialFadeAnimations.includes((e=>e.action._clip.name===i))){var t=this.findEventTargets(e);this.materialFadeAnimations.push(A(A({},e),{},{targets:t}))}}))}onAnimationFinished(e,t){var i=e.action._clip.name;t.forEach((e=>{if(!this.materialFadeAnimations.includes((e=>e.action._clip.name===i))){var t=this.findEventTargets(e);this.materialFadeAnimations.push(A(A({},e),{},{targets:t}))}}))}glow(){var{glow:e}=this.artifact;this.model.traverse((t=>{if(k(t.name,"glow")){var i=T.bool(e)?238:e,a=new j({color:i,side:O,blending:R,transparent:!0});t.material=a}}))}addClickables(){var{artifact:t,controller:i,model:a,preload:r,renderer:n,XR:o}=this,{clickables:s=[],clickableChildren:l=!1}=t,d=[];if(!0===s?d.push(a):s.length&&a.traverse((e=>{s.forEach((t=>{if(T.str(t)&&(t={target:t}),_({node:e,search:t.target})){var i;t.node=e,t.hide&&(e.material.transparent=!0,e.material.opacity=0);var a=!0===t.audio?e.name:t.audio;if(null!==(i=r.assets.audioElements)&&void 0!==i&&i.length){var n=r.assets.audioElements.find((e=>{var{ele:t}=e;return t.dataset.name===a}));n&&(t.player=n.ele)}d.includes(t)||d.push(t)}}))})),d.length){var{Controls:c}=r.assets;this.controls=new c({clickableChildren:l,clickables:d,engine:this}),o?e.on(i,"select",this.controls.select,!1):e.on(n.domElement,"mousedown",this.controls.click,!1)}}onTouch(t){var i;null!==(i=this.sceneInstance)&&void 0!==i&&i.onTouch&&this.sceneInstance.onTouch(t),t.forEach(((t,i)=>{if(!(i+1>this.artifact.maxTouches)){var{emission:a,emissionIntensity:r=.2,link:n,player:o}=t;if(n&&(L?window.location.href=n:window.open(n,"_hacked")),o&&(o.loop?o.paused?o.play():(o.currentTime=0,o.pause()):(o.currentTime=0,o.play())),a){var s=t.node.name.split("_")[0],l=this.model.getObjectByName(s);if(!l)return void console.warn("node not found",s);("Group"===l.type?l.children:[l]).forEach((i=>{if(i){if(i.userData.origEmissive||(i.userData.origEmissive=i.material.emissive),i.userData.origEmissiveIntensity||(i.userData.origEmissiveIntensity=i.material.emissiveIntensity),o||console.warn("player not found",t.node.name),o)if(B.same(i.material.emissive,i.userData.origEmissive)){var n=new I(1,1,1);T.bool(a)?i.material.color&&(n=i.material.color):T.arr(a)&&(n=new I(...a)),i.material.emissive=n,i.material.emissiveIntensity=r,o.loop||e.on(o,"ended",(()=>{i.material.emissive=i.userData.origEmissive,i.material.emissiveIntensity=i.userData.origEmissiveIntensity}))}else o.loop&&(i.material.emissive=i.userData.origEmissive,i.material.emissiveIntensity=i.userData.origEmissiveIntensity)}else console.warn("node not found",s)}))}}}))}nosort(){this.renderer.sortObjects=!1}clip(){var{artifact:e,model:t}=this,{clipSide:i,clipInFallback:a}=e;t.traverse((e=>{if(k(e.name,"clip"))if(this.XR||!1!==a){var t=i||e.material.side;e.material=new j({color:"green",colorWrite:!1,side:t}),e.castShadow=!1,e.receiveShadow=!1,e.renderOrder=1}else e.visible=!1;else e.renderOrder=2}))}addUnderwaterPlane(){var e=this;return r((function*(){e.cameraPlane=new e.preload.assets.UnderwaterPlane({engine:e}),yield e.cameraPlane.preload(e)}))()}addSkybox(){var e=this;return r((function*(){var{artifact:t,preload:i,renderer:a,scene:r,XR:n}=e,o=ie,s=null==t?void 0:t.skySphere;T.arr(s)&&s.length&&(o=s);var l=new F(...o),d=i.assets.skybox,c=new j({map:d,side:D}),h=new x(l,c);if(h.rotation.y=W.degToRad(180),h.visible=!n,r.add(h),!1!==t.light&&!t.hideEnvironment){var u=new N(a);u.compileEquirectangularShader();var m=u.fromEquirectangular(d).texture;r.environment=m,m.dispose(),u.dispose()}e.skybox=h}))()}addAudio(){this.listener=new H,this.camera.add(this.listener)}addFog(){var{artifact:e,scene:t}=this,{fog:i,fogexp2:a}=e;if(i){var{color:r,near:n,far:o}=i;t.fog=new V(r,n,o)}if(a){var{color:s,density:l}=a;t.fog=new U(s,l)}}startMedia(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];if(!this.isMediaPlaying){this.isMediaPlaying=!0;var{actions:t=[],artifact:i,preload:a}=this,{videoElement:r,audioElements:n=[]}=a.assets;i.triggerAudio||null!=n&&n.length&&n.forEach((t=>{var{config:i,ele:a}=t;i.autoplay?(e&&(a.currentTime=0),i.volume&&(T.fn(a.setVolume)?a.setVolume(i.volume):a.volume=i.volume),a.play()):i.random&&(i.interval=z(i.interval),this.randomAudioElements.push({ele:a,config:i}))})),r&&!i.triggerVideo&&(e&&(r.currentTime=0),r.play()),t.forEach((e=>e.play()))}}stopMedia(){var{preload:e,videoElement:t,actions:i=[],audioElements:a=[]}=this;t&&t.pause(),e.hls&&e.hls.destroy(),i&&i.length&&i.forEach((e=>e.stop())),a.forEach((e=>{var{ele:t}=e;return t.pause()})),this.isMediaPlaying=!1}toggleAnimations(){this.actions.forEach((e=>e.paused=!e.paused))}initFallbackSession(){var e=this;return r((function*(){var t;e.XR=!1,u.B.classList.add(X);var{camera:i,artifact:a,model:r,renderer:n}=e,{clickable:o}=a,{Controller:s}=e.preload.assets;s&&(e.controller=new s(i,n.domElement,a,e),e.controller.unspawn&&e.unspawnObjects.push(e.controller)),e.skybox.visible=!0,o?e.hud.showAnimToggler(e.toggleAnimations):e.hud.hideAnimToggler();var{cam:l={}}=a,d=ae,{x:c=d.x,y:h=d.y,z:m=d.z}=l;i.position.set(c,h,m);var{scale:p}=a;if(p&&r){var{x:f,y:v,z:g}=r.scale;T.num(p)&&r.scale.set(f*p,v*p,g*p)}T.fn(null==e||null===(t=e.controller)||void 0===t?void 0:t.update)&&e.controller.update();yield e.spawnModel(!0),n.domElement.focus()}))()}loadModel(){var e=this;return r((function*(){var t,i,a,{artifact:r,preload:n,sceneInstance:o={}}=e,{spatialObjects:s=[],audioElements:l=[]}=r;(e.spatials=[...s,...l],null!=o&&o.model&&(e.model&&e.model!==o.model?e.model.add(o.model):e.model||(e.model=o.model)),null!==(t=n.assets.gltf)&&void 0!==t&&t.scene)&&(e.model?e.model.add(null===(i=n.assets.gltf)||void 0===i?void 0:i.scene):e.model=null===(a=n.assets.gltf)||void 0===a?void 0:a.scene);if(r.ply&&n.assets.addPly(e),e.addAnimations(),e.model){var d,c;e.artifact.hideChildren&&e.artifact.hideChildren.forEach((t=>{var i=e.model.getObjectByName(t);i&&i.position.set(5e3,5e3,5e3)}));var h={},{parentName:u=o.parentName,child:m=o.child}=e;if(u&&m&&(c=e.model.getObjectByName(u),e.modelParent=c),e.model.traverse((t=>{if(e.customObjects.forEach((e=>{var{object:i}=e;i.parentName&&i.child&&k(t.name,i.parentName)&&(h[i.name]=t)})),t.isMesh){var{frustumCulled:i,transparent:a,castShadow:n,receiveShadow:o,noShadowObjects:s=[],noShadowCastObjects:l=[],noShadowReceiveObjects:d=[]}=r;(!1===i||null!=i&&i.includes(t.name))&&(t.frustumCulled=!1),!1===a&&(t.material.transparent=!1),k(t.name,"noshadow")||s.includes(t.name)||(k(t.name,"noshadowcast")||l.includes(t.name)||(t.castShadow=!1!==n),k(t.name,"noshadowreceive")||d.includes(t.name)||(t.receiveShadow=!1!==o)),k(t.name,"videotarget")&&e.videoTargets.push(t),t.material.map&&(t.material.map.anisotropy=16,t.material.map.colorSpace=q),t.material.emissiveMap&&(t.material.emissiveMap.colorSpace=q),(t.material.map||t.material.emissiveMap)&&(t.material.needsUpdate=!0)}var c=[];r.animateObjects&&r.animateObjects.forEach((i=>{if(k(t.name,i.name)){var a=e.actions.find((e=>e._clip.name===t.name));if(i.sound){!0===i.sound&&(i.sound={name:e.artifact.slug}),i.sound.name||(i.sound.name=e.artifact.slug);var r=e.preload.assets.animateObjects[i.sound.name];if(r){var n=new G(e.listener);n.setBuffer(r);var{loopSound:o=!0}=i;if(n.setLoop(o),i.audio=n,i.sound.distance){var s=!1!==i.sound.yDistanceTest;c.push({buffer:n,distance:i.sound.distance,distanceTarget:t.name,target:t.name,yDistanceTest:s})}}else console.error("animateObjects: Sound not found in preload.assets",i)}e.animateObjects.push(A(A({},i),{},{action:a,node:t}))}})),e.spatials=[...e.spatials,...c]})),e.spatials.length){var{SpatialObjects:p}=yield import("./vendor.js").then((function(e){return e.bp}));e.objects.spatialObjects=new p(e)}if(null!==(d=r.lookAtCameraObjects)&&void 0!==d&&d.length){var f=new n.assets.LookAtCamera(e);e.addRenderStep(f.render.bind(f))}if(c&&(o.child?c.add(o.child):e.child&&c.add(e.child)),e.customObjects.forEach((t=>{var{object:i}=t;i.child?h[i.name].add(i.child):i.model&&e.model.add(i.model)})),e.videoElement&&e.videoTargets.length){var v,{flipVideo:g,chromaKey:w}=r,y=new K(e.videoElement);!1!==g&&(y.flipY=!1);var{examples:b={}}=null===(v=e.preload)||void 0===v?void 0:v.assets,{ChromaKeyMaterial:T=!1}=b;e.videoTargets.forEach((e=>{w?T&&(e.material=new T(w,y)):e.material.map=y}))}}var{clip:S,glow:E,portal:C,nosort:x,clones:P,clonesOnMeshes:j}=e.artifact;if(E&&e.glow(),C&&e.addPortal(),e.model&&S&&e.clip(),x&&e.nosort(),n.assets.Mirrors&&new n.assets.Mirrors(e),e.artifact.analyseAudio){var{AnalyseAudio:M}=yield import("./vendor.js").then((function(e){return e.bq})),O=new M(e);e.addRenderStep(O.render)}if(e.model){if(e.model.position.set(5e3,5e3,5e3),P){var{Clones:R}=yield import("./vendor.js").then((function(e){return e.br}));e.clones=new R(e)}if(j){var{ClonesOnMeshes:_}=yield import("./vendor.js").then((function(e){return e.bs}));e.meshClones=new _(e)}e.scene.add(e.model)}}))()}addAnimations(){var t,i,a;if(null!==(t=this.sceneInstance)&&void 0!==t&&null!==(t=t.animations)&&void 0!==t&&t.length&&this.animations.push(...this.sceneInstance.animations),null!==(i=this.preload.assets.gltf)&&void 0!==i&&null!==(i=i.animations)&&void 0!==i&&i.length&&this.animations.push(...this.preload.assets.gltf.animations),this.actions=[],null!==(a=this.animations)&&void 0!==a&&a.length){var r;this.mixer=new Y(this.model);var{animations:n={}}=this.artifact,{loop:o,startOnTouch:s,clampWhenFinished:l=!0,autoplay:d=!0,noLoopAnimations:c=[],pausedAnimations:h=[],timeScale:u=1}=n;if(this.animations.forEach((e=>{var t=this.mixer.clipAction(e),i=h.includes(e.name),a=s||!d||i;(!1===o||c.includes(e.name))&&(t.clampWhenFinished=l,t.loop=Z),a&&(t.paused=!0),T.num(u)?t.timeScale=u:T.obj(u)&&u.hasOwnProperty(t.name)&&(t.timeScale=u[t.name]),this.actions.push(t)})),null!==(r=this.artifact.events)&&void 0!==r&&r.animation){var{events:m}=this.artifact,{times:p=[],loop:f=[],finished:v=[]}=null==m?void 0:m.animation;if(f.length){var g=[this.mixer,"loop",e=>this.onAnimationLoop(e,f)];e.on(...g),g.targets=this.findEventTargets(f),this.eventsToRemove.push(g)}if(v.length){var w=[this.mixer,"finished",e=>this.onAnimationFinished(e,v)];e.on(...w),w.targets=this.findEventTargets(v),this.eventsToRemove.push(w)}if(p.length){var{times:y}=this.artifact.events.animation;y.length&&y.forEach((e=>{var{action:t,once:i=!1}=e,a=J.findByName(this.animations,t),r=this.findEventTargets(e);this.animationListeners.push(A(A({},e),{},{once:i,action:a,targets:r}))}))}}}}findEventTargets(e){var t=[];return this.model.traverse((i=>{_({node:i,search:e.targets})&&(i.material&&(t.includes(i.material)||t.push(i.material)))})),t}spawnModel(e){var t=this;return r((function*(){var i,{artifact:a,camera:r,controller:n,model:o,reticle:s,scene:l,sceneInstance:d={},shadowPlane:c,type:h,XR:u}=t,{showSkybox:m,skyboxTransparency:p,floatSpawnAtZeroY:f=!1}=a;if(!u||e)o&&o.position.set(0,0,0),t.modelSpawned=!0;else if(t.isHittestScene()){if(!t.modelSpawned&&t.lastHit){s.updateMatrixWorld(),o.position.setFromMatrixPosition(s.matrixWorld),o.updateMatrixWorld();var v=r.position,g=o.position,w=v.x-g.x,y=v.z-g.z,b=Math.atan2(w,y);o.rotation.y=b,c&&(c.position.setFromMatrixPosition(s.matrixWorld),l.add(c)),o.visible=!0,s.visible=!1,t.modelSpawned=!0}}else if(h===ye.Float){var S=o.clone();S.position.set(0,0,-1).applyMatrix4(n.matrixWorld),f&&(S.position.y=0),l.add(S)}if(t.applyPositionAndRotation(),null!=d&&d.spawnModel&&(console.warn("W_DEPRECATED: sceneInstance.spawnModel is deprecated. Please use sceneInstance.afterSpawnModel instead."),d.spawnModel({engine:t})),null!=d&&d.afterSpawnModel&&d.afterSpawnModel({engine:t}),t.startMedia(),m&&(t.skybox.visible=!0,p&&(t.skybox.material.transparent=!0,t.skybox.material.opacity=p),t.skybox.receiveShadow=!1),null!==(i=t.preload.gui)&&void 0!==i&&i.afterSpawnModel){var{afterSpawnModel:E}=t.preload.gui;E.style.visibility="visible",E.style.opacity=1,setTimeout((()=>{var e;T.fn(null===(e=E.parentNode)||void 0===e?void 0:e.removeChild)&&E.parentNode.removeChild(E)}),8e3)}}))()}exitSceneInstance(){var t,i;this.modelSpawned&&(this.scene.remove(this.model),this.modelSpawned=!1,this.isAnimationRunning=!1,this.stopMedia(),this.justUnspawned=!0,null!==(i=this.eventsToRemove)&&void 0!==i&&i.length&&this.eventsToRemove.forEach((t=>{e.off(...t)})),this.unspawnObjects.forEach((e=>{null==e||e.unspawn(this)})),setTimeout((()=>{this.justUnspawned=!1}),200));this.customObjects.forEach((e=>{var{object:t}=e;T.fn(t.exit)&&t.exit({engine:this})})),this.customMaterials.forEach((e=>{var{material:t}=e;T.fn(t.exit)&&t.exit({engine:this})})),this.animateObjects.forEach((e=>{var t;null===(t=e.audio)||void 0===t||t.stop()})),null!==(t=this.sceneInstance)&&void 0!==t&&t.exit&&this.sceneInstance.exit({engine:this}),this.frameRateIndicator&&e.remove(this.frameRateIndicator)}applyPositionAndRotation(){var{artifact:e,model:t}=this;if(t){var{pos:i={},rot:a={}}=e,{x:r,y:n,z:o}=i;r&&(t.position.x+=r),n&&(t.position.y+=n),o&&(t.position.z+=o);var{x:s,y:l,z:d}=a,c=W.degToRad;s&&t.rotateX(c(s)),l&&t.rotateY(c(l)),d&&t.rotateZ(c(d))}}endSession(){var t,i;if(null===(t=this.session)||void 0===t||!t.ended){this.session&&(this.session.end(),this.session.ended=!0),this.hud.hide(),this.renderer.setAnimationLoop(null),e("#".concat(v)).classList.remove("visible"),this.exitSceneInstance(),this.scene&&$(this.scene),e.remove(".".concat(Q)),null!==(i=this.preload)&&void 0!==i&&i.hls&&(this.preload.hls.destroy(),e.remove(this.preload.hlsScript));var a=e("#".concat(m));if(a){var r=a.parentNode;r.id===v?e.remove(a):e.remove(r)}u.B.classList.remove(X),e(".start-experience-button").forEach((e=>{e.removeAttribute("disabled")})),L&&u.location.reload()}}isHittestScene(){return![ye.Float].includes(this.type)}addRenderStep(e){this.renderSteps.push(e)}render(e,t){var i=this;return r((function*(){var a,r,n,o,s,l,d=i.clock.getDelta();if(i.renderHittest(t),i.mixer)if(i.artifact.videoBoundAnimation&&i.videoElement){i.lastFrameVideoTime||(i.lastFrameVideoTime=i.videoElement.currentTime);var c=i.videoElement.currentTime-i.lastFrameVideoTime;c&&i.mixer.update(c),i.lastFrameVideoTime=i.videoElement.currentTime}else i.mixer.update(d);var h,u={delta:d,timestamp:e,engine:i,frame:t};if(i.modelSpawned){if(t&&g&&i.XR){var m=t.getPose(i.anchor.anchorSpace,i.localRefSpace);if(null!=m&&m.transform){var{x:p,y:f,z:v}=m.transform.position;i.model.position.set(p,f,v);var{x:w,y:y,z:b,w:T}=m.transform.orientation;i.model.quaternion.set(w,y,b,T)}}i.renderSteps.forEach((e=>{e(u)}))}(i.artifact.showVideoTime&&(i.frameRateIndicator.innerText="Videotime: ".concat(i.videoElement.currentTime)),null!==(a=i.sceneInstance)&&void 0!==a&&a.tick&&i.sceneInstance.tick(u),null!==(r=i.artifact.ply)&&void 0!==r&&r.animated&&i.renderPlyMorphTargetInfluences(u),null!==(n=i.animateObjects)&&void 0!==n&&n.length&&i.renderAnimateObjects(u),null!==(o=i.animationListeners)&&void 0!==o&&o.length&&i.renderAnimationTimeEvent(u),i.materialFadeAnimations.length&&i.renderMaterialAnimTick(u),null!==(s=i.randomAudioElements)&&void 0!==s&&s.length&&i.renderRandomAudio(u),i.particles&&i.particles.update(u),i.customObjects.length&&i.renderCustomObjects(u),null!==(l=i.sceneInstance)&&void 0!==l&&l.render?i.sceneInstance.render(u):i.renderer.render(i.scene,i.camera),i.controller)&&(null!==(h=i.controller)&&void 0!==h&&h.update&&i.controller.update(d))}))()}renderRenderTargets(e){var{renderTargets:t}=this;t.forEach((e=>{e.off.length&&e.off.forEach((e=>{e.visible=!1})),this.renderer.setRenderTarget(e.object),this.renderer.render(scene,camera),this.renderer.setRenderTarget(null),e.off.length&&e.off.forEach((e=>{e.visible=!0}))}))}renderPlyMorphTargetInfluences(e){var{delta:t,timestamp:i}=e;this.nextMorphTargetStep||(this.nextMorphTargetStep=i+this.morphTargetInfluenceConfig.delay);var a=this.animatedPoints,r=a.morphTargetInfluences.length-1,n=t*this.morphTargetInfluenceConfig.speed;a.morphTargetInfluences=a.morphTargetInfluences.map(((e,t)=>{if(t===this.morphTargetTargetIndex){var a=Math.min(e+n,1);return a>=1&&i>this.nextMorphTargetStep&&(this.nextMorphTargetStep=i+this.morphTargetInfluenceConfig.delay,this.hasRun=!this.hasRun,this.hasRun||(this.morphTargetTargetIndex+=1,this.morphTargetTargetIndex>r&&(this.morphTargetTargetIndex=0))),a}return Math.max(e-n,0)}))}renderCustomObjects(e){this.customObjects.forEach((t=>{var{object:i}=t;T.fn(i.tick)&&i.tick(e)}))}renderAnimateObjects(e){var{timestamp:t}=e;this.animateObjects.forEach((e=>{var{action:i,audio:a,speed:r,minSpeed:n=0,maxDelay:o=2,minDelay:s=1}=e;if(i&&i.paused&&(e.nextAnimation||(e.nextAnimation=t+Math.random()*(1e3*o)+1e3*s),a.isPlaying&&a.stop(),e.nextAnimation<=t)){e.nextAnimation=!1;var l=Math.random()>.5?1:-1,d=Math.max(n,Math.random()*r)*l;i.timeScale=d,i.paused=!1,i.play(),a&&!a.isPlaying&&a.play()}}))}renderHittest(t){var i=this;return r((function*(){if(i.modelSpawned)i.hud.hideSpawnButton();else if(t&&i.XR){var a=i.renderer.xr.getSession();i.hitTestSourceRequested||(i.hitTestSource=yield a.requestHitTestSource({space:i.refSpace}),e.on(a,"end",(()=>{i.hitTestSourceRequested=!1,i.hitTestSource=null})),i.hitTestSourceRequested=!0);var r=t.getHitTestResults(i.hitTestSource);if(r.length){if(i.lastHit=r[0],g&&(i.anchor=yield i.lastHit.createAnchor()),!i.modelSpawned){i.reticle.visible=!0,i.hud.showSpawnButton();var n=i.renderer.xr.getReferenceSpace();i.reticle.matrix.fromArray(i.lastHit.getPose(n).transform.matrix)}i.hud.hideHitSearch()}else i.reticle.visible=!1,i.modelSpawned||(i.hud.showHitSearch(),i.hud.hideSpawnButton()),i.lastHit=void 0}}))()}renderAnimationTimeEvent(){this.animationListeners.forEach((e=>{var{time:t,action:i,once:a}=e,{time:r}=i;!e.hasTriggered&&r>=t?(e.hasTriggered=!0,this.materialFadeAnimations.push(e)):r<=t&&(a||(e.hasTriggered=!1))}))}renderRandomAudio(e){var{timestamp:t}=e;this.modelSpawned&&this.randomAudioElements.forEach((e=>{var{ele:i,config:a}=e;if(i.paused&&(a.nextPlayTime||(a.nextPlayTime=t+ee(a.interval)),a.nextPlayTime<=t)){i.time=0,i.play();var r=ee(a.interval);a.nextPlayTime=t+r+1e3*i.duration}}))}renderMaterialAnimTick(e){var{delta:t}=e;this.materialFadeAnimations.forEach(((e,i)=>{if(e){var{targets:a=[],speed:r=1,to:n=0,props:o}=e;a.forEach((e=>{var a=T.arr(o)?o:[o],s=!0;a.map((i=>{var a=e[i]+r*t;r<0?a<=n?a=n:s=!1:r>0&&(a>=n?a=n:s=!1),e[i]=a})),s&&this.materialFadeAnimations.splice(i,1)}))}}))}}var Te=(e,t)=>T.arr(t)||T.str(t)?t.includes(e)||t===e:null==t?void 0:t.hasOwnProperty(e);class Se{constructor(t){var{artifact:i,root:a,THREE:r,XR:n=!0}=t;this.artifact=i,this.root=a,this.XR=!1===n?n:u.SUPPORTS.XR,r&&(this.THREE=r);var{android:o,chrome:s}=pe;this.isAndroidChrome=o&&s,this._warningContainer=e("#timeout-warning"),this._header=e("#timeout-warning-header"),this._headerDone=e("#timeout-warning-header-done"),this._preloadInfo=e("#timeout-warning-info"),this._cancelButton=e("#timeout-warning-cancel"),this._confirmButton=e("#timeout-warning-confirm"),this._tooFarContainer=e("#toofar-warning"),this._tooFarPreviewButton=e("#toofar-warning-load-preview-button"),this._tooFarDistanceInfo=e("#toofar-warning-distance"),this._tooFarCancelButton=e("#toofar-warning-cancel-button"),this._tooFarAbortButton=e("#toofar-warning-abort-button"),this._webglDisabledContainer=e("#timeout-warning-webgl-disabled"),this._webglDisabledOkButton=e("#timeout-warning-webgl-disabled-ok-button"),this.confirmButtonClickHandler=this.confirmButtonClickHandler.bind(this),e.on(this._confirmButton,"click",this.confirmButtonClickHandler),this.onTooFarCancelButtonClick=this.onTooFarCancelButtonClick.bind(this),this.onTooFarPreviewButtonClick=this.onTooFarPreviewButtonClick.bind(this),this.onWebglDisabledOkButtonClick=this.onWebglDisabledOkButtonClick.bind(this),this.promisifiedLoad=this.promisifiedLoad.bind(this),this.textureLoader=new re,this.gltfLoader=new ne,this.plyLoader=new oe,this.audioLoader=new se,this.fontLoader=new le,this.audioElements=[],this.collectPreloadPromises(),this.startEngine=this.startEngine.bind(this),this.onVideoCanPlayThrough=this.onVideoCanPlayThrough.bind(this)}collectPreloadPromises(){var{animateObjects:e,audio:t,audioElements:i,chromaKey:a,clickables:r=[],customMaterials:n,customObjects:o,fonts:s,glb:l,gui:d,mirrors:c,ply:h,textures:u,type:m,video:p,lookAtCameraObjects:f,microphone:v,ocean:g,particles:w,portal:y,rapier:b,record3d:S,record3DImages:E,triggerVideo:C,underwater:x,ws:P}=this.artifact,j={};if(j.skybox=this.loadSkybox(),(t||i)&&(j.audioElements=this.loadAudioElements()),C&&(j.VideoTrigger=this.loadVideoTrigger()),x&&(j.UnderwaterPlane=this.loadUnderwaterPlane()),w&&(j.Particles=this.loadParticles()),null!=c&&c.length&&(j.Mirrors=this.loadMirrors(c)),(null==c?void 0:c.some((e=>e.water)))&&(j.mirrorTextures=this.loadMirrorTextures(c)),v&&(promise.Microphone=this.loadMicrophone()),r.length&&(j.Controls=this.loadControls()),b&&(j.RAPIER=this.loadRapier()),g&&(j.OceanPlane=this.loadOceanPlane(),j.waterNormals=this.loadWaterNormals()),de(m,APP_DB.SCENE_TYPES)||(j.scene=this.loadScene()),!1!==l&&(j.gltf=this.loadGltf()),h&&(j.ply=this.loadPly(),j.addPly=this.loadAddPly()),u&&(j.textures=this.loadTextures()),a){var A=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return T.str(t)&&(t=str.split(" ")),T.arr(t)?t.push(e):T.obj(t)&&(t[e]=!0),t}("ChromaKeyMaterial",this.artifact.examples);this.artifact.examples=A}if(y&&(j.Portal=this.loadPortal()),S&&(j.Record3D=this.loadRecord3D(),S.images&&(j.textures=this.loadRecord3DTextures(j.textures))),E&&(j.Record3DImages=this.loadRecord3DImages(E.images)),P&&(j.WS=this.loadWS()),p){var{slug:k,video:M}=this.artifact;j.videoElement=this.loadVideo({slug:k,video:M})}null!=f&&f.length&&(j.LookAtCamera=this.loadLookAtCamera()),s&&(j.fonts=this.loadFonts()),this.artifact.examples&&(j.examples=this.loadExamples()),d&&this.loadGui(),n&&(j.customMaterials=this.loadCustomMaterials(),j.CustomMaterials=this.loadCustomMaterialClasses()),o&&(j.customObjects=this.loadCustomObjects()),e&&(j.animateObjects=this.loadAnimateObjects()),this.XR||this.artifact.noControls||(j.Controller=this.loadController()),this.promises=j}init(){var t=this;return r((function*(){t._isWorking=!0,t._isCancelled=!1,t._session=!1,e.on(t._cancelButton,"click",(()=>{t._isCancelled=!0,t.finished()})),e.show([t._warningContainer,t._header]),t.timeout=u.setTimeout(t.showTimeoutWarning,ce),yield t.startEngine()}))()}loadScene(){var t=this;return r((function*(){var{artifact:i}=t,a=APP_DB.SCENE_TYPES,{type:r=a.Hit}=i,n=Object.entries(a).find((e=>{var[t,i]=e;return i===r})),o="".concat(t.root,"/CustomScene.js");if(T.arr(n)){var s=n[0];o="./scenes/".concat(s,".js")}var{default:d}=yield import(o),c=new d({artifact:i,mergeConfig:l,nodeNameIncludes:k,nodeNameMatchesWildcard:_,preload:t,$:e,W:u,is:T});return T.fn(null==c?void 0:c.preload)?yield c.preload({artifact:i,preload:t}):T.fn(null==c?void 0:c.load)&&(yield c.load({artifact:i,preload:t})),c}))()}loadWS(){return r((function*(){var{WS:e}=yield import("./WS.js");return e}))()}loadMirrors(){return r((function*(){var{Mirrors:e}=yield import("./vendor.js").then((function(e){return e.bt}));return e}))()}loadMirrorTextures(e){var t=this;return r((function*(){var i=[],a=e.filter((e=>e.water));if(a.length){var r=new Set(a.map((e=>e.water)));Array.from(r).forEach((e=>{!0===e&&(e="waterTexture001"),e.endsWith(".jpg")||(e+=".jpg"),i.includes(e)||i.push(e)}))}return yield Promise.all(i.map((e=>t.promisifiedLoad({loader:t.textureLoader,file:"https://static.artificialmuseum.com/textures/mirrors/".concat(e)}))))}))()}loadMicrophone(){return r((function*(){var{Microphone:e}=yield Promise.resolve().then((function(){return Ee}));return e}))()}loadAddPly(){return r((function*(){var{addPly:e}=yield import("./vendor.js").then((function(e){return e.bu}));return e}))()}loadParticles(){return r((function*(){var{Particles:e}=yield import("./vendor.js").then((function(e){return e.bv}));return e}))()}loadLookAtCamera(){return r((function*(){var{LookAtCamera:e}=yield import("./vendor.js").then((function(e){return e.bw}));return e}))()}loadSkybox(){var e=this;return r((function*(){var{city:t,sky:i,slug:a}=e.artifact,r=i||a;he(r)||(r=["https://static.artificialmuseum.com","skybox",t,r].filter((e=>e)).join("/"));var n="jpg";return u.SUPPORTS.WEBP&&(n="webp"),r.endsWith(".".concat(n))||(r+=".".concat(n)),yield e.promisifiedLoad({loader:e.textureLoader,file:r})}))()}loadFonts(){var e=this;return r((function*(){var{fonts:t}=e.artifact,i={};return yield Promise.all(t.map(function(){var t=r((function*(t){var a="https://static.artificialmuseum.com/font/json/".concat(t,".typeface.json");i[t]=yield e.promisifiedLoad({loader:e.fontLoader,file:a})}));return function(e){return t.apply(this,arguments)}}())),i}))()}loadAnimateObjects(){var e=this;return r((function*(){var{animateObjects:t,slug:i}=e.artifact,a={},n=e.audioLoader;return yield Promise.all(t.map(function(){var t=r((function*(t){if(t.sound){var{sound:r={}}=t;if(!0===r&&(r={name:i}),r.name||(r.name=i),!a[r.name]){var o=".mp3";u.SUPPORTS.A_MP4?o=".mp4":u.SUPPORTS.A_OGG&&(o=".ogg");var s="https://media.artificialmuseum.com/audio/".concat(r.name).concat(o);a[r.name]=yield e.promisifiedLoad({loader:n,file:s})}}}));return function(e){return t.apply(this,arguments)}}())),a}))()}loadExamples(){var e=this;return r((function*(){var{examples:t}=e.artifact,i=[];Te("TextGeometry",t)&&i.push(["TextGeometry",import("./vendor.js").then((function(e){return e.bx}))]),Te("ChromaKeyMaterial",t)&&i.push(["ChromaKeyMaterial",import("./materials/ChromaKeyMaterial.js")]);var a=yield Promise.all(i.map(function(){var e=r((function*(e){var[t,i]=e,a=yield i,r=a[t]?a[t]:a.default;return r||console.error("E_MODULE_NOT_FOUND","module ".concat(t," could not be imported from examples, got:"),i),[t,r]}));return function(t){return e.apply(this,arguments)}}()));return Object.fromEntries(a)}))()}loadCustomMaterials(){var e=this;return r((function*(){var{artifact:t}=e,{customMaterials:i}=t;return Promise.all(i.map(function(){var i=r((function*(i){var a=i.name.endsWith("Material")?i.name:"".concat(i.name,"Material"),{default:r}=yield import("./materials/".concat(a,".js")),n=new r({artifact:t,config:i,preload:e});return T.fn(n.preload)?yield n.preload({artifact:t,config:i}):T.fn(n.load)&&(yield n.load({artifact:t,config:i})),{config:i,material:n}}));return function(e){return i.apply(this,arguments)}}()))}))()}loadRapier(){return r((function*(){var{default:e}=yield import("./rapier.es.js");return yield e.init(),e}))()}loadCustomMaterialClasses(){return r((function*(){var{CustomMaterials:e}=yield import("./vendor.js").then((function(e){return e.by}));return e}))()}loadCustomObjects(){var e=this;return r((function*(){var{artifact:t}=e,{customObjects:i}=t;return Promise.all(i.map(function(){var i=r((function*(i){var{default:a}=yield import("./objects/".concat(i.name,".js")),r=new a({artifact:t,config:i,preload:e});return T.fn(r.preload)&&(yield r.preload()),r}));return function(e){return i.apply(this,arguments)}}()))}))()}loadRecord3D(){return r((function*(){var{Record3D:e}=yield import("./vendor.js").then((function(e){return e.bn}));return e}))()}loadRecord3DImages(){var e=arguments,t=this;return r((function*(){var i=e.length>0&&void 0!==e[0]?e[0]:[],a=t.textureLoader,{Record3DImages:n}=yield import("./vendor.js").then((function(e){return e.bz})),o=yield Promise.all(i.map(function(){var e=r((function*(e){var i="https://static.artificialmuseum.com/".concat(e.src,"?v=").concat(t.artifact.version),{position:r,quaternion:n,intrMat:o}=e;return{object:yield t.promisifiedLoad({loader:a,file:i}),position:r,quaternion:n,intrMat:o}}));return function(t){return e.apply(this,arguments)}}()));return{Class:n,images:o}}))()}loadRecord3DTextures(){var e=arguments,t=this;return r((function*(){var i=e.length>0&&void 0!==e[0]?e[0]:{},a=t.textureLoader;return yield Promise.all(t.artifact.record3d.images.map(function(){var e=r((function*(e){var r=e.file?e.file:e,n=r;he(n)||(n=["https://static.artificialmuseum.com","livedata",t.artifact.livedataCategory,n].filter((e=>e)).join("/"));var o=yield t.promisifiedLoad({loader:a,file:n});i[r]=o}));return function(t){return e.apply(this,arguments)}}())),i}))()}handlePlacardName(e){var{name:t,ext:i=".jpg",type:a,slug:r}=e;return(t=T.str(t)?t:r).endsWith("/")&&(t+=r),t.endsWith(".png")?(i=".png",t.slice(0,-4)):t.endsWith(".jpg")&&(i=".jpg",t.slice(0,-4)),i.startsWith(".")||(i=".".concat(i)),he(t)||(t="https://static.artificialmuseum.com/placards/".concat(t,"_").concat(a).concat(i)),t}loadPortal(){var e=this;return r((function*(){var{placardImage:t=!1,placardExtension:i=".jpg",load:a}=e.artifact.portal,{Portal:n}=yield import("./vendor.js").then((function(e){return e.bA})),o=[["Factory",n]];if(!1!==t){var{slug:s}=e.artifact,l=e.handlePlacardName({name:t,ext:i,type:"color",slug:s}),d=e.handlePlacardName({name:t,ext:i,type:"normal",slug:s});o.push(["placardColor",e.promisifiedLoad({loader:e.textureLoader,file:l})]),o.push(["placardNormal",e.promisifiedLoad({loader:e.textureLoader,file:d})])}if(!1!==a){var{file:c=1,inside:h=1}=e.artifact.portal;!T.int(c)&&he(c)||(T.int(c)||T.str(c))&&(c=T.int(c)?"portal-".concat(c):c,c="".concat(u.GLB_URL,"/portals/").concat(c,".glb")),o.push(["glb",e.promisifiedLoad({loader:e.gltfLoader,file:c})])}var m=yield Promise.all(o.map(function(){var e=r((function*(e){var[t,i]=e;return[t,yield i]}));return function(t){return e.apply(this,arguments)}}()));return Object.fromEntries(m)}))()}loadVideo(t){var i=this;return r((function*(){var{dir:a,slug:r,video:n,id:o=fe}=t,s=!0===n?r:n,l=e.create("video",{id:o,class:Q,loop:!0,playsinline:!0,preload:"auto",crossorigin:"anonymous"});i.videoElement=l;var d=["webm","mp4"],c=T.str(s)?s:r,[h,m=""]=c.split("?"),p=h.endsWith("m3u8")||h.startsWith("blob:")||i.artifact.hlsVideo;if(p){if(""!==l.canPlayType("application/vnd.apple.mpegurl"))return l.src=h,e.append(l),l;var f=e.create("script",{src:"".concat(u.ROOT_URL,"/hls.js"),parent:u.B});return i.hlsScript=f,new Promise((t=>{e.on(f,"load",(()=>{Hls.isSupported()&&(i.hls=new u.Hls,i.hls.loadSource(h),e.append(l),i.hls.attachMedia(l),i.hls.once(Hls.Events.FRAG_LOADED,(()=>{t(l)})))}))}))}if(h.endsWith(".mp4")?(d=["mp4"],h=h.slice(0,-4)):h.endsWith(".webm")&&(d=["webm"],h=h.slice(0,-5)),he(h)||(h=a?"video/".concat(a,"/").concat(h):"video/".concat(h,"/").concat(h),h="".concat(u.MEDIA_URL,"/").concat(h)),m||(m="v=".concat(ve)),d.forEach((t=>{e.create("source",{src:"".concat(h,".").concat(t,"?").concat(m),type:"video/".concat(t),parent:l})})),e.append(l),!p){var{videoWidth:v}=l;return v>0?l:new Promise((t=>{if(ue){var i=e=>{l.videoWidth>0?e(l):setTimeout((()=>i(e)),50)};i(t)}else e.on(l,"canplaythrough",(e=>t(e.target)))}))}}))()}onVideoCanPlayThrough(e){var{e:t,resolve:i}=e;ue?setTimeout((()=>{i(t.target)}),me):i(t.target)}loadAudioSourceRoot(e){var[t,i]=e.split("?"),a=["ogg","mp4","mp3"];t.endsWith(".mp3")?(a=["mp3"],t=t.slice(0,-4)):t.endsWith(".mp4")&&(a=["mp4"],t=t.slice(0,-4));var r=t.startsWith("http")?t:"".concat(u.MEDIA_URL,"/audio/").concat(t);return i||(i="v=".concat(ve)),{audioFileTypes:a,audioSourceRoot:r,request:i}}loadControls(){return r((function*(){var{Controls:e}=yield import("./Controls.js");return e}))()}loadOceanPlane(){return r((function*(){var{OceanPlane:e}=yield import("./vendor.js").then((function(e){return e.bB}));return e}))()}loadWaterNormals(){var e=this;return r((function*(){var t,{normals:i="oceannormals1"}=null===(t=e.artifact)||void 0===t?void 0:t.ocean;return yield e.promisifiedLoad({loader:e.textureLoader,file:"https://static.artificialmuseum.com/textures/ocean/".concat(i,".jpg")})}))()}loadVideoTrigger(){return r((function*(){var{VideoTrigger:e}=yield import("./vendor.js").then((function(e){return e.bC}));return e}))()}loadUnderwaterPlane(){return r((function*(){var{UnderwaterPlane:e}=yield import("./vendor.js").then((function(e){return e.bD}));return e}))()}loadAudioElements(){var t=this;return r((function*(){var{audioElements:i=[],slug:a}=t.artifact;if(t.artifact.audio){var{audio:n=t.artifact.slug}=t.artifact;!0===n&&(n=t.artifact.slug),i.push({autoplay:!0,audio:n})}return yield Promise.all(i.map(function(){var i=r((function*(i,n){var o=T.str(i.audio)?i.audio:a,s="".concat(ge,"-").concat(n);e.remove("#".concat(s));var l=e.create("audio",{class:Q,crossorigin:"anonymous","data-name":o,preload:"auto",id:s});!1!==i.loop&&(l.loop="true"),t.audioElements[n]={ele:l,config:i};var{audioSourceRoot:d,audioFileTypes:c,request:h}=t.loadAudioSourceRoot(o);c.forEach((t=>{var i=".".concat(t),a=d;a.endsWith(i)||(a+=i),e.create("source",{src:"".concat(a,"?").concat(h),type:"audio/".concat(t),parent:l})})),e.append(l);var{duration:u}=l;return T.num(u)&&u>0?{ele:l,config:i}:new Promise((t=>{if(ue){var a=e=>{T.num(l.duration)&&l.duration>0?e({ele:l,config:i}):setTimeout((()=>a(e)),50)};a(t)}else e.on(l,"canplaythrough",function(){var e=r((function*(e){t({ele:e.target,config:i})}));return function(t){return e.apply(this,arguments)}}())}))}));return function(e,t){return i.apply(this,arguments)}}()))}))()}loadTextures(){var e=this;return r((function*(){var{textures:t={}}=e.artifact,{dir:i,names:a}=t,n="jpg";u.SUPPORTS.WEBP&&(n="webp"),i&&!i.endsWith("/")&&(i="".concat(i,"/"));var o={};return yield Promise.all(a.map(function(){var t=r((function*(t){var a=t;he(i)||(a="https://static.artificialmuseum.com/textures/".concat(i,"/").concat(t)),a.endsWith(n)||(a="".concat(a,".").concat(n));var r=yield e.promisifiedLoad({loader:e.textureLoader,file:a});o[a]=r}));return function(e){return t.apply(this,arguments)}}())),o}))()}loadController(){var e=this;return r((function*(){var{fpsControls:t,pointerLockControls:i,touchControls:a}=e.artifact;if(t||i||a){if(g||ue){var{ArmTouchControls:r}=yield import("./controls/ArmTouchControls.js");return r}var{ArmPointerLockControls:n}=yield import("./controls/ArmPointerLockControls.js");return n}var{ArmOrbitControls:o}=yield import("./controls/ArmOrbitControls.js");return o}))()}loadGltf(){var e=this;return r((function*(){var{artifact:t,XR:i}=e,{file:a,version:r=1}=t,n=i?"&xr=1":"",o=he(a)?a:"".concat(u.GLB_URL,"/").concat(a,".glb?v=").concat(r).concat(n);return yield e.promisifiedLoad({loader:e.gltfLoader,file:o})}))()}loadPly(){var e=this;return r((function*(){var t,{artifact:i,XR:a}=e,{file:n,ply:o={},version:s=1}=i,l=a?"&xr=1":"",d=o.files;if(d&&!T.arr(d)&&(d=[d]),null!==(t=d)&&void 0!==t&&t.length)return yield Promise.all(d.map(function(){var t=r((function*(t){var i=t;if(i){he(i)||(i="https://static.artificialmuseum.com/ply/".concat(i)),i.endsWith(".ply")||(i+=".ply"),i+="?v=".concat(s).concat(l);var a=yield e.promisifiedLoad({loader:e.plyLoader,file:i});return a.name=t.replace(".ply","").split("/").pop(),a}console.error("empty ply file name",d,i)}));return function(e){return t.apply(this,arguments)}}()));var c="string"==typeof o?o:n;null!=o&&o.file&&(c=o.file);var h="?v=".concat(s).concat(l),u=c.endsWith(".ply")?c:"".concat(c,".ply");return he(c)||(u="https://static.artificialmuseum.com/ply/".concat(u)),u+=h,yield e.promisifiedLoad({loader:e.plyLoader,file:u})}))()}loadGui(){var{title:t,button:i,body:a}=this.artifact.gui.afterSpawnModel,r=[];t&&r.push(e.create("h3",{innerText:t})),a&&r.push(e.create("div",{innerText:a})),r.length&&(i&&r.push(e.create("button",{id:"afterSpawnModelButton",class:"styled margin inverse",innerText:i,on:{click:e=>{var t=e.target.parentNode;t.parentNode.removeChild(t)}}})),this.gui={afterSpawnModel:e.create("div",{class:"w hudgui",children:r,parent:"#hud"})})}promisifiedLoad(e){var{loader:t,file:i}=e;return i.file&&(i=i.file),new Promise(((e,a)=>{t.load(i,(t=>{e(t)}),(()=>{}),(e=>{this.setError(e,"Error loading artifact.",5e3),a(e)}))}))}startEngine(){var t=this;return r((function*(){var{artifact:i,XR:a}=t,n=Object.entries(t.promises).map(function(){var e=r((function*(e){var[t,i]=e;return[t,yield i]}));return function(t){return e.apply(this,arguments)}}()),o=yield Promise.all(n);t.assets=Object.fromEntries(o);var s=new be({artifact:i,preload:t,XR:a}),l=yield s.init(t.assets.scene);if(!l)throw new Error("Session undefined.");e.hide(t._header),e.hide(t._preloadInfo),e.show(t._headerDone),t._session=l,t._timeoutShown&&t.isAndroidChrome?e.prop(t._confirmButton,{disabled:!1}):t._isCancelled||(yield t.finishLoad())}))()}showTimeoutWarning(){e.show(this._preloadInfo),this.isAndroidChrome&&(e.show(this._confirmButton),this._confirmButton.setAttribute("disabled",!0),this._timeoutShown=!0)}confirmButtonClickHandler(){var t=this;return r((function*(){t._session?(e.off(t._confirmButton,"click",t.confirmButtonClickHandler),yield t.finishLoad(),t.finished()):console.error("confirmButtonClickHandler: session not defined",t)}))()}finishLoad(){var t=this;return r((function*(){if(t._session){var{hud:i,initFallbackSession:a,initScene:r}=t._session;try{yield r(),i.show(),e.show("#".concat(v)),t.finished()}catch(r){"InvalidStateError"===r.name||"NotSupportedError"===r.name?(yield a(),i.show(),e.show("#".concat(v)),t.finished()):"SecurityError"===r.name?(e.show(t._confirmButton),e.prop(t._confirmButton,{disabled:!1})):(console.error("Unexpected Preload.finishLoad error"),console.error(r))}}}))()}setError(e,t){console.warn(e,t),u.clearTimeout(this.timeout),this.finished()}showTooFarNotification(t){var{distance:i,artifact:a,map:r}=t,n="meter",o=i;o>=1e3?(n="kilometer",o>=2e3&&(n+="s"),o=Math.round(o/1e3)):o>=2&&(n+="s"),this.artifact=a,this.map=r,this.XR=!1,this._tooFarDistanceInfo.innerText="This artifact is ".concat(o," ").concat(n," away."),e.show(this._tooFarContainer),e.on(this._tooFarPreviewButton,"click",this.onTooFarPreviewButtonClick),e.on(this._tooFarCancelButton,"click",this.onTooFarCancelButtonClick),e.on(this._tooFarAbortButton,"click",this.onTooFarCancelButtonClick)}onTooFarCancelButtonClick(){e.off(this._tooFarPreviewButton,"click",this.onTooFarPreviewButtonClick),this._isCancelled=!0,e.hide(this._tooFarContainer),this.finished()}onTooFarPreviewButtonClick(){var t=this;return r((function*(){e.off(t._tooFarPreviewButton,"click",t.onTooFarPreviewButtonClick),e.off(t._tooFarCancelButton,"click",t.onTooFarCancelButtonClick),e.off(t._tooFarAbortButton,"click",t.onTooFarCancelButtonClick),e.hide(t._tooFarContainer),yield t.init()}))()}showWebglDisabledNotification(){e.show(this._webglDisabledContainer),e.hide([this._header,this._headerDone,this._preloadInfo,this._cancelButton,this._confirmButton]),e.on(this._webglDisabledOkButton,"click",this.onWebglDisabledOkButtonClick)}onWebglDisabledOkButtonClick(){e.off(this._webglDisabledOkButton,"click",this.onWebglDisabledOkButtonClick),this._isCancelled=!0,e.hide(this._webglDisabledContainer),this.finished()}finished(){this._isWorking=!1,this._timeoutShown=!1,e(".start-experience-button").forEach((e=>{e.removeAttribute("disabled")})),e.hide([this._warningContainer,this._confirmButton,this._preloadInfo,this._headerDone]),e.prop(this._confirmButton,{disabled:!0}),e.show(this._header),u.clearTimeout(this.timeout)}}var Ee=Object.freeze({__proto__:null});export{Se as Preload};
