import{aR as e,az as t,a1 as i,aS as r,aT as a,a5 as n,an as o,aK as s,aU as l,aV as c,aM as p}from"../vendor.js";var h=["artifact","$","W"];class v{constructor(t){var{artifact:i,$:r,W:a}=t;e(t,h),this.W=a,this.$=r;var{filterSize:n="1",minDepth:o="0.1",maxDepth:s="5.0",depthThresholdFilter:l="0.9",scale:c="7.0",ptSize:p=1,pixelDepth:v="2.0",permanentSeconds:d=[],useBone:f=!1,parentName:x="parent"}=i;this.shaderConfig={filterSize:n,minDepth:o,maxDepth:s,depthThresholdFilter:l,scale:c,ptSize:(p*window.devicePixelRatio).toFixed(1).toString(),pixelDepth:v},this.permanentSeconds=d,this.currentSecondId=0,this.useBone=f,this.parentName=x}init(e){var{engine:a,preload:n}=e;this.engine=a,this.preload=n;var{videoElement:o}=n.assets,{videoWidth:s,videoHeight:l}=o,c=new t(o,{minFilter:i});this.pointCopies=[],this.canvases=[],this.permanentSeconds.forEach(((e,t)=>{var n=this.$.create("canvas",{height:l,width:s,style:{position:"fixed",left:"100vw"},parent:this.W.B});this.canvases.push(n);var o=new r(n,{minFilter:i}),c=this.createPoints(o,"0.1");c.visible=!1,this.pointCopies.push(c),a.scene.add(c)}));var p=this.createPoints(c,"1.0");this.useBone?this.child=p:this.model=p}createPoints(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"1.0",{artifact:i={}}=this.engine,{videoElement:r}=this.preload,{videoWidth:h,videoHeight:v}=r,d=new a,{ifx:f=.00125,ify:x=.00125,itx:u=-.4,ity:m=-.6}=i,{filterSize:S,minDepth:g,maxDepth:z,depthThresholdFilter:D,scale:P,ptSize:y,pixelDepth:I}=this.shaderConfig,w=new n({uniforms:{texImg:{type:"t",value:e},texSize:{type:"i2",value:[h,v]},iK:{type:"f4",value:[f,x,u,m]},alpha:{type:"f",value:t},filterSize:{type:"f",value:S},minDepth:{type:"f",value:g},maxDepth:{type:"f",value:z},depthThresholdFilter:{type:"f",value:D},scale:{type:"f",value:P},ptSize:{type:"f",value:y},pixelDepth:{type:"f",value:I}},side:o,transparent:!0,vertexShader:"#define GLSLIFY 1\nattribute float vertexIdx;varying float vVertexIdx;varying vec2 vPtPos;uniform ivec2 texSize;uniform sampler2D texImg;uniform vec4 iK;uniform float scale;uniform float minDepth;uniform float maxDepth;uniform float pixelDepth;uniform int filterSize;uniform float ptSize;uniform float depthThresholdFilter;float rgb2hue(vec3 c){vec4 K=vec4(0.0,-1.0/3.0,2.0/3.0,-1.0);vec4 p=mix(vec4(c.bg,K.wz),vec4(c.gb,K.xy),step(c.b,c.g));vec4 q=mix(vec4(p.xyw,c.r),vec4(c.r,p.yzx),step(p.x,c.r));float d=q.x-min(q.w,q.y);float e=1.0e-10;return abs(q.z+(q.w-q.y)/(6.0*d+e));}float getPixelDepth(ivec2 pixel){vec2 lookupPt=(vec2(pixel)+vec2(0.5))/vec2(texSize);float hue=rgb2hue(texture2D(texImg,lookupPt).rgb);float pixelDepth=pixelDepth*hue;return pixelDepth;}bool shouldDiscard(ivec2 currPixel){float centerPixelDepth=getPixelDepth(currPixel);for(int i=-filterSize;i<=filterSize;i++){for(int j=-filterSize;j<=filterSize;j++){if(i==0&&j==0){continue;}float currDepth=getPixelDepth(currPixel+ivec2(j,i));if(currDepth<minDepth||currDepth>=maxDepth||abs(centerPixelDepth-currDepth)>depthThresholdFilter){return true;}}}return false;}void main(){ivec2 frameSize=ivec2(texSize.x/2,texSize.y);int vertIdx=int(vertexIdx);int actualNumPts=frameSize.x*frameSize.y;if(vertIdx>=actualNumPts){gl_Position=vec4(0.0);return;}int ptY=vertIdx/int(frameSize.x);int ptX=vertIdx-ptY*int(frameSize.x);ivec2 pt=ivec2(ptX,ptY);if(shouldDiscard(pt)){gl_Position=vec4(0.0);return;}float currDepth=getPixelDepth(pt);vec3 ptPos=scale*vec3((iK.x*float(ptX)+iK.z)*currDepth,(iK.y*float(ptY)+iK.w)*currDepth,-currDepth);vec4 mvPos=modelViewMatrix*vec4(ptPos,1.0);gl_Position=projectionMatrix*mvPos;vPtPos=vec2(float(ptX),float(ptY));vVertexIdx=vertexIdx;gl_PointSize=ptSize;}",fragmentShader:"#define GLSLIFY 1\nvarying float vVertexIdx;varying vec2 vPtPos;uniform ivec2 texSize;uniform sampler2D texImg;uniform float alpha;void main(){vec2 frameSizeF=vec2(texSize.x/2,texSize.y);ivec2 frameSize=ivec2(frameSizeF);int vertIdx=int(vVertexIdx);int actualNumPts=frameSize.x*frameSize.y;if(vertIdx>=actualNumPts){discard;}vec2 lookupPt=(vec2(vPtPos.x+frameSizeF.x,vPtPos.y)+vec2(0.5))/vec2(texSize);vec3 currColor=texture2D(texImg,lookupPt).rgb;gl_FragColor=vec4(currColor,alpha);}"}),F=h/2*v,b=new Uint32Array(F),C=new Float32Array(F),K=0;K<F;K++)b[K]=K,C[K]=K;var T=new s;T.setAttribute("vertexIdx",new l(C,1)),T.setIndex(new c(new Uint32Array(b),1));var W=new p(T,w);return W.frustumCulled=!1,d.add(W),d}exit(){this.$.remove(this.canvasImgs)}renderCopies(e){new Promise((t=>{var{videoElement:i}=e,{videoHeight:r,videoWidth:a}=i;if(this.waitForSecond){if(i.currentTime>this.waitForSecond){this.canvases[this.currentSecondId].getContext("2d").drawImage(i,0,0,a,r);var n=this.pointCopies[this.currentSecondId];n.visible=!0,this.child.matrixWorld.decompose(n.position,n.rotation,n.scale),this.currentSecondId++,this.waitForSecond=this.permanentSeconds[this.currentSecondId]}}else this.waitForSecond=this.permanentSeconds[this.currentSecondId];t()}))}render(e,t,i){var{engine:r}=i,{camera:a,renderer:n,scene:o}=r;this.currentSecondId<this.permanentSeconds.length&&this.renderCopies(r),n.render(o,a)}}export{v as default};
