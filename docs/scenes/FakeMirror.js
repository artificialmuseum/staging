import{$ as e,aj as t,aF as i,W as a,aG as s,aH as o,aI as n,az as d,V as h,ax as r,aJ as l,aK as p,aA as c}from"../vendor.js";import{v,f}from"../FakeMirrorVertex.js";class m{constructor(e){var{artifact:t}=e,{filterSize:i="1",minDepth:a="0.1",maxDepth:s="5.0",depthThresholdFilter:o="0.9",scale:n="7.0",ptSize:d=1,depthScale:h="1.0",pixelDepth:r="2.0",permanentSeconds:l=[],useBone:p=!1,parentName:c="parent",playbackRate:v=1,loopVideo:f=!0,continueVideoSound:m=!1,useFog:u=!1,addFog:g=1e-4,fogColor:S=16448250,rotation:y={},videoAlpha:x=1,permanentAlpha:w=.1,hideModelsOnVideoEnded:F=[],addReflector:C=!1}=t;this.shaderConfig={filterSize:i,minDepth:a,maxDepth:s,depthThresholdFilter:o,scale:n,depthScale:h,ptSize:(d*window.devicePixelRatio).toFixed(1).toString(),pixelDepth:r},this.permanentSeconds=l,this.currentSecondId=0,this.useBone=p,this.parentName=c,this.useFog=u,this.addFog=g,this.fogColor=S,this.loopVideo=f,this.continueVideoSound=m,this.hideModelsOnVideoEnded=F,this.addReflector=C,this.videoAlpha=x,this.permanentAlpha=w,this.rotation=y,this.playbackRate=v,this.hideCharacter=this.hideCharacter.bind(this)}beforeLoadModel(n){var{engine:d,preload:h}=n;this.engine=d,this.preload=h;var{videoElement:r}=h.assets,{videoWidth:l,videoHeight:p}=r;if(r){r.playbackRate=this.playbackRate,this.modelsToHide=[],(this.hideModelsOnVideoEnded.length||!1===this.loopVideo)&&(e.on(r,"seeked",this.hideCharacter),this.hideModelsOnVideoEnded.forEach((e=>{var t=h.assets.gltf.scene.getObjectByName(e);t.material.transparent=!0,this.modelsToHide.push(t)})));var c=new t(r,{minFilter:i});this.pointCopies=[],this.canvases=[],this.permanentSeconds.forEach(((t,o)=>{var n=e.create("canvas",{height:p,width:l,style:{position:"fixed",left:"100vw"},parent:a.B});this.canvases.push(n);var h=new s(n,{minFilter:i}),r=this.createPoints(h,this.permanentAlpha);r.visible=!1,this.pointCopies.push(r),d.scene.add(r)}));var v=this.createPoints(c,this.videoAlpha),f=this.rotation;f.x&&v.rotateX(f.x),f.y&&v.rotateY(f.y),f.z&&v.rotateZ(f.z),this.useBone?this.child=v:this.model=v,this.useFog&&(this.fog=new o(this.fogColor,.005),this.engine.scene.fog=this.fog)}else console.error("videoElement not defined",{engine:d,preload:h})}hideCharacter(){this.hasTriggeredOnce?this.fadeOutModel=!0:this.hasTriggeredOnce=!0}createPoints(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"1.0",{artifact:i={}}=this.engine,{videoElement:a}=this.preload,{videoWidth:s,videoHeight:o}=a,m=new n,{ifx:u=.00125,ify:g=.00125,itx:S=-.4,ity:y=-.6}=i,{filterSize:x,minDepth:w,maxDepth:F,depthScale:C,depthThresholdFilter:b,scale:I,ptSize:z,pixelDepth:D}=this.shaderConfig,E=new d({uniforms:{texImg:{type:"t",value:e},texSize:{type:"i2",value:[s,o]},iK:{type:"f4",value:[u,g,S,y]},alpha:{type:"f",value:t},filterSize:{type:"f",value:x},minDepth:{type:"f",value:w},maxDepth:{type:"f",value:F},depthThresholdFilter:{type:"f",value:b},scale:{type:"f",value:I},ptSize:{type:"f",value:z},pixelDepth:{type:"f",value:D},depthScale:{type:"f",value:C}},side:h,transparent:!0,vertexShader:v,fragmentShader:f}),V=s/2*o,A=new Uint32Array(V),T=new Float32Array(V),O=0;O<V;O++)A[O]=O,T[O]=O;var M=new r;M.setAttribute("vertexIdx",new l(T,1)),M.setIndex(new p(new Uint32Array(A),1));var k=new c(M,E);return k.frustumCulled=!1,m.add(k),m}exit(){e.remove(this.canvasImgs)}renderCopies(e){new Promise((t=>{var{videoElement:i}=e,{videoHeight:a,videoWidth:s}=i;if(this.waitForSecond){if(i.currentTime>this.waitForSecond){this.canvases[this.currentSecondId].getContext("2d").drawImage(i,0,0,s,a);var o=this.pointCopies[this.currentSecondId];o.visible=!0,this.child.matrixWorld.decompose(o.position,o.rotation,o.scale),this.currentSecondId++,this.waitForSecond=this.permanentSeconds[this.currentSecondId]}}else this.waitForSecond=this.permanentSeconds[this.currentSecondId];t()}))}tick(e){var{engine:t}=e;if(this.currentSecondId<this.permanentSeconds.length&&this.renderCopies(t),this.fog&&this.addFog&&(this.fog.density+=this.addFog),this.fadeOutModel&&!this.hasFaded){this.modelsToHide.forEach((e=>{e.material.opacity>0?e.material.opacity-=.05:e.visible&&(e.visible=!1)}));var i=this.model||this.child;if(i&&i.visible){var a,s,o,n=null==i?void 0:i.children[0];(null==n||null===(a=n.material)||void 0===a||null===(s=a.uniforms)||void 0===s||null===(o=s.alpha)||void 0===o?void 0:o.value)>0?n.material.uniforms.alpha.value-=.05:i.visible&&(i.visible=!1,this.continuePlayingNonLoopedVideo&&this.preload.videoElement.pause())}}}}export{m as default};
