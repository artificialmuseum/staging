import{bc as t,bd as e,be as i,aj as s,a5 as a,ae as o,bf as h,as as n,bg as r,$ as d,bh as l,au as c,bi as v}from"../vendor.js";import{RotationPad as p}from"./RotationPad.js";import{MovementPad as u}from"./MovementPad.js";import"./utils.js";var m=new WeakMap,w=new WeakMap,f=new WeakMap,M=new WeakMap,k=new WeakMap,y=new WeakMap,g=new WeakMap,b=new WeakMap,B=new WeakMap,x=new WeakMap,P=new WeakMap,W=new WeakMap,E=new WeakMap,R=new WeakMap,Y=new WeakMap,D=new WeakMap,L=new WeakSet,S=new WeakSet,j=new WeakSet;class T{constructor(d,l,c,v){t(this,j),t(this,S),t(this,L),e(this,"rotationPad",void 0),e(this,"movementPad",void 0),e(this,"container",void 0),e(this,"config",void 0),e(this,"fpsBody",void 0),e(this,"mouse",void 0),e(this,"enabled",!0),i(this,m,{writable:!0,value:void 0}),i(this,w,{writable:!0,value:void 0}),i(this,f,{writable:!0,value:void 0}),i(this,M,{writable:!0,value:void 0}),i(this,k,{writable:!0,value:void 0}),i(this,y,{writable:!0,value:!1}),i(this,g,{writable:!0,value:!1}),i(this,b,{writable:!0,value:!1}),i(this,B,{writable:!0,value:!1}),i(this,x,{writable:!0,value:!1}),i(this,P,{writable:!0,value:!1}),i(this,W,{writable:!0,value:!1}),i(this,E,{writable:!0,value:!1}),i(this,R,{writable:!0,value:!1}),i(this,Y,{writable:!0,value:1}),i(this,D,{writable:!0,value:1}),this.container=l.parentNode.parentNode,this.canvas=l,this.camera=v.camera,this.config=s(c.touchControls,{delta:.75,moveSpeed:.03,rotationSpeed:.003,maxPitch:0,hitTest:!1,hitTestDistance:40}),this.camConfig=s(c.cam,{x:0,y:1.7,z:5});var T=s(c,{floorTargets:[]});T.floorTargets.length&&(this.targets=T.floorTargets.map((t=>v.model.getObjectByName(t))).filter((t=>t)),this.targets.length&&(this.currentCameraHeight=1.7,this.rayOrigin=new a,this.rayDirection=new a(0,-1,0),this.floorRay=new o)),h(this,w,[]),h(this,f,[]),h(this,k,this.config.maxPitch*Math.PI/180),h(this,M,new a(0,0,0)),this.mouse=new n,this.fpsBody=v.camera,this.rotationPad=new p(this),this.rotationPad.padElement.addEventListener("YawPitch",(t=>{var e=r(this,S,C).call(this,t.detail.deltaX,t.detail.deltaY);this.setRotation(e.rx,e.ry)})),this.movementPad=new u(this),this.movementPad.padElement.addEventListener("move",(t=>{h(this,Y,Math.abs(t.detail.deltaY)),h(this,D,Math.abs(t.detail.deltaX)),t.detail.deltaY==t.detail.middle?(h(this,Y,1),h(this,g,h(this,b,!1))):t.detail.deltaY>t.detail.middle?(h(this,g,!0),h(this,b,!1)):t.detail.deltaY<t.detail.middle&&(h(this,g,!1),h(this,b,!0)),t.detail.deltaX==t.detail.middle?(h(this,D,1),h(this,x,h(this,B,!1))):t.detail.deltaX<t.detail.middle?(h(this,x,!0),h(this,B,!1)):t.detail.deltaX>t.detail.middle&&(h(this,x,!1),h(this,B,!0))})),this.movementPad.padElement.addEventListener("stopMove",(t=>{h(this,Y,h(this,D,1)),h(this,g,h(this,b,h(this,B,h(this,x,!1))))})),this.container.addEventListener("contextmenu",(t=>{t.preventDefault()})),this.container.addEventListener("mousedown",(t=>this.onMouseDown(t))),this.container.addEventListener("mouseup",(t=>this.onMouseUp(t))),document.addEventListener("keydown",(t=>this.onKeyDown(t))),document.addEventListener("keyup",(t=>this.onKeyUp(t))),document.addEventListener("mousemove",(t=>this.onMouseMove(t))),document.addEventListener("mouseout",(t=>this.onMouseOut(t))),r(this,L,X).call(this)}unspawn(){d.remove(this.movementPad.padElement),d.remove(this.rotationPad.padElement)}onMouseDown(t){this.enabled&&2===t.button&&(h(this,y,!0),t.preventDefault(),t.stopPropagation())}onMouseUp(t){this.enabled&&2===t.button&&h(this,y,!1)}onMouseMove(t){if(this.mouse.x=t.clientX/window.innerWidth*2-1,this.mouse.y=-t.clientY/window.innerHeight*2+1,this.enabled&&l(this,y)){var e=t.movementX||0,i=t.movementY||0,s=r(this,S,C).call(this,-1*e,-1*i);this.setRotation(s.rx,s.ry)}}onMouseOut(t){h(this,y,!1)}onKeyDown(t){if(this.enabled)switch(t.keyCode){case 38:case 87:h(this,g,!0);break;case 37:case 65:h(this,B,!0);break;case 40:case 83:h(this,b,!0);break;case 39:case 68:h(this,x,!0)}}onKeyUp(t){switch(t.keyCode){case 38:case 87:h(this,g,!1);break;case 37:case 65:h(this,B,!1);break;case 40:case 83:h(this,b,!1);break;case 39:case 68:h(this,x,!1)}}updateRayCaster(t){this.floorRay.set(this.camera.position,this.rayDirection);var e=this.floorRay.intersectObjects(this.targets).filter((t=>t.object.visible)),i=0;e.length?e.forEach((t=>{var e=t.point.y;i=e+this.currentCameraHeight})):i=this.currentCameraHeight,this.targetY=i}update(){this.config.hitTest&&this.hitTest(),l(this,M).x+=-1*l(this,M).x*this.config.delta,l(this,M).z+=-1*l(this,M).z*this.config.delta,l(this,g)&&!l(this,P)&&(l(this,M).z-=l(this,Y)*this.config.moveSpeed*this.config.delta),l(this,b)&&!l(this,W)&&(l(this,M).z+=l(this,Y)*this.config.moveSpeed*this.config.delta),l(this,B)&&!l(this,E)&&(l(this,M).x-=l(this,D)*this.config.moveSpeed*this.config.delta),l(this,x)&&!l(this,R)&&(l(this,M).x+=l(this,D)*this.config.moveSpeed*this.config.delta),this.floorRay&&(this.updateRayCaster(),this.fpsBody.position.y=this.targetY),this.fpsBody.translateX(l(this,M).x),this.fpsBody.translateZ(l(this,M).z)}hitTest(){this.unlockAllDirections(),h(this,f,[]);for(var t=this.getDirection2(new a(0,0,0)).clone(),e=0;e<4;e++){var i=t.clone();i.applyMatrix4(l(this,w)[e]);var s=new o(this.fpsBody.position,i).intersectObject(l(this,m),!0);s.length>0&&s[0].distance<this.config.hitTestDistance&&(r(this,j,O).call(this,e),l(this,f).push(s[0]))}return l(this,f)}getDirection2(t){var e=new a(0,0,-1),i=new c(0,0,0,"YXZ"),s=this.fpsBody.rotation.x,o=this.fpsBody.rotation.y;return i.set(s,o,0),t.copy(e).applyEuler(i),t}getDirection(){var t=0,e=0,i=new a(0,0,-1),s=new c(0,0,0,"YXZ");return null!=self&&(t=this.fpsBody.rotation.x,e=this.fpsBody.rotation.y),a=>(s.set(t,e,0),a.copy(i).applyEuler(s),a)}isMoveLeft(){return l(this,B)}isMoveRight(){return l(this,x)}isMoveForward(){return l(this,g)}isMoveBackward(){return l(this,b)}lockMoveForward(t){h(this,P,t)}lockMoveBackward(t){h(this,W,t)}lockMoveLeft(t){h(this,E,t)}lockMoveRight(t){h(this,R,t)}unlockAllDirections(){this.lockMoveForward(!1),this.lockMoveBackward(!1),this.lockMoveLeft(!1),this.lockMoveRight(!1)}addToScene(t){h(this,m,t),l(this,m).add(this.fpsBody)}setPosition(t,e,i){this.fpsBody.position.set(t,e,i)}stopMouseMoving(){h(this,y,!1)}setRotation(t,e){null!==t&&(this.fpsBody.rotation.x=t),null!==e&&(this.fpsBody.rotation.y=e)}getHitObjects(){return l(this,f)}}function X(){var t=new v;t.makeRotationY(0),l(this,w).push(t);var e=new v;e.makeRotationY(180*Math.PI/180),l(this,w).push(e);var i=new v;i.makeRotationY(90*Math.PI/180),l(this,w).push(i);var s=new v;s.makeRotationY(270*Math.PI/180),l(this,w).push(s)}function C(t,e,i){var s=i||this.config.rotationSpeed,a=this.fpsBody.rotation.y-t*s,o=this.fpsBody.rotation.x-e*s;return{rx:o=Math.max(-l(this,k),Math.min(l(this,k),o)),ry:a}}function O(t){0==t?this.lockMoveForward(!0):1==t?this.lockMoveBackward(!0):2==t?this.lockMoveLeft(!0):3==t&&this.lockMoveRight(!0)}export{T as ArmTouchControls};
